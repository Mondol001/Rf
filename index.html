<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zubair Works Space</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Select2 CSS (used only for Order Search in Modify Modal) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- jQuery (required for Select2 in Modify Modal) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Reset & Global Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; background: #fdfdfd; color: #333; min-height: 100vh; }
    
    /* Header with Glossy Effect, Menu & Random Logo */
    header { 
      background: linear-gradient(135deg, #f6d365, #fda085); 
      padding: 20px; 
      color: #fff; 
      text-align: center;
      position: relative;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      margin-bottom: 10px;
    }
    .logo { 
      height: 50px; 
      width: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    .menu ul {
      list-style: none;
      display: flex;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    .menu ul li a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
    }
    /* Animated Rainbow Title (Glossy Typer) */
    header h1 {
      font-size: 2em;
      animation: rainbow 5s infinite;
    }
    @keyframes rainbow {
      0%   { color: red; }
      14%  { color: orange; }
      28%  { color: yellow; }
      42%  { color: green; }
      57%  { color: blue; }
      71%  { color: indigo; }
      85%  { color: violet; }
      100% { color: red; }
    }
    
    /* Container */
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    
    /* Glossy Buttons */
    button { 
      background: linear-gradient(145deg, #ffcc00, #ff9900);
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      color: #fff;
      font-size: 1em;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    button:hover {
      background: linear-gradient(145deg, #ff9900, #ffcc00);
      box-shadow: 0 6px 10px rgba(0,0,0,0.4);
    }
    
    /* Filter Area */
    .filter-area { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filter-area label { font-weight: 500; margin-bottom: 5px; display: block; }
    .filter-area input, .filter-area select { border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; }
    
    /* Advanced Filter (Only Date Picker & Seed No) */
    .advanced-filter-toggle { background: #f6d365; padding: 8px 14px; border-radius: 4px; color: #fff; cursor: pointer; }
    .advanced-filter { 
      background: #fff; padding: 15px; border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 10px; margin-bottom: 20px; 
      display: none; flex-wrap: wrap; gap: 10px; 
    }
    .advanced-filter.active { display: flex; }
    .advanced-filter > div { display: flex; flex-direction: column; }
    
    /* Modal Styles */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 1000;
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: #fff; width: 90%; max-width: 500px; border-radius: 8px; padding: 20px;
      position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    /* Make Modals Scrollable */
    #dataModal .modal-content { max-height: 90vh; overflow-y: auto; }
    .modify-modal .modal-content { max-width: 80vw; max-height: 80vh; overflow: auto; }
    .modal-content h2 { margin-bottom: 15px; text-align: center; }
    .modal-content .close { position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; color: #888; }
    .modal-content .close:hover { color: #333; }
    .modal-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 10; }
    
    form label { margin-top: 10px; display: block; font-weight: 500; }
    form input, form textarea, form select { width: 100%; margin-top: 5px; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    
    /* Datalist Styles (using browser default) */
    
    /* Photo Input Wrapper */
    .photo-input-wrapper { display: flex; flex-direction: column; gap: 10px; }
    .mobile-only { display: none; }
    @media (max-width: 767px) { .mobile-only { display: block; } }
    
    /* Table Styles */
    .table-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    table thead tr { background: linear-gradient(135deg, #f6d365, #fda085); color: #fff; }
    table th, table td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
    table tbody tr:nth-child(even) { background: #f9f9f9; }
    table tbody tr:hover { background: #f1f1f1; }
    table img { border-radius: 4px; cursor: pointer; }
    /* Table Footer for Overall Subtotal */
    table tfoot tr { background: #f6d365; color: #fff; font-weight: bold; }
    
    /* Action Icon in Modify Modal's Results */
    .action-icon { cursor: pointer; font-size: 20px; }
    
    /* Nested Action Modal */
    .nested-modal {
      position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
      z-index: 1100; display: none;
    }
    .nested-modal.show { display: block; }
    
    /* Global Loading Overlay */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
    }
    .loading-overlay.show { opacity: 1; pointer-events: auto; }
    .spinner { width: 40px; height: 40px; border: 4px solid #ccc; border-top: 4px solid #fda085; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* Photo Modal with Zoom & Pan */
    .photo-modal { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; 
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 2000; 
    }
    .photo-modal.show { opacity: 1; pointer-events: auto; }
    .photo-modal-content { position: relative; max-width: 90%; max-height: 90%; }
    .photo-modal-content img { width: 100%; height: auto; border-radius: 4px; display: block; transition: transform 0.2s ease; }
    .photo-modal .close-photo { position: absolute; top: -40px; right: 0; color: #fff; font-size: 30px; cursor: pointer; }
    #photoSpinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
    
    /* Footer */
    footer { text-align: center; padding: 10px; background: #333; color: #fff; margin-top: 20px; }
    
    /* Toast Message */
    .toast { 
      position: fixed; top: 10px; right: 10px; background: #fda085; 
      color: #fff; padding: 10px 15px; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
      opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; 
      z-index: 3000; pointer-events: none; 
    }
    .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .toast.error { background: #d9534f; }
    
    /* Count & QTY Input Row */
    .count-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    .count-row label {
      font-weight: 500;
      margin-bottom: 0;
      white-space: nowrap;
    }
    .count-row select,
    .count-row input[type="number"] {
      width: 80px;
      padding: 4px;
    }
  </style>
</head>
<body>
  <!-- Header with Random Logo & Animated Glossy Title -->
  <header>
    <div class="header-top">
      <img src="https://picsum.photos/50" alt="Logo" class="logo">
      <nav class="menu">
        <ul>
          <li><a href="#">হোম</a></li>
          <li><a href="#">সেবা</a></li>
          <li><a href="#">যোগাযোগ</a></li>
        </ul>
      </nav>
    </div>
    <h1>Zubair Works Space</h1>
  </header>
  
  <!-- Global Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>
  
  <div class="container">
    <!-- Top Controls -->
    <div class="top-controls">
      <button id="openModalBtn">ডেটা এন্ট্রি করুন</button>
      <button id="modifyBtn">মডিফাই করুন</button>
      <button id="printBtn">প্রিন্ট করুন</button>
    </div>
    <!-- Filter Area -->
    <div class="filter-area">
      <div>
        <label for="filterOrderNo">অর্ডার নং</label>
        <input type="text" id="filterOrderNo" placeholder="অর্ডার নং">
      </div>
      <div>
        <button class="advanced-filter-toggle" id="toggleFilterBtn">অ্যাডভান্সড ফিল্টার</button>
      </div>
    </div>
    <!-- Advanced Filter (Only Date Picker & Seed No) -->
    <div class="advanced-filter" id="advancedFilterSection">
      <div>
        <label for="filterDate">তারিখ</label>
        <input type="date" id="filterDate">
      </div>
      <div>
        <label for="filterSeedNo">সেড নং</label>
        <input type="text" id="filterSeedNo" placeholder="সেড নং">
      </div>
    </div>
    <!-- Main Data Table with Overall Subtotal Footer -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>তারিখ</th>
            <th>অর্ডার নং</th>
            <th>পার্টি নাম</th>
            <th>সেড নং</th>
            <th>কালার নাম</th>
            <th>কাউন্ট &amp; QTY</th>
            <th>রেমার্কস</th>
            <th>ফটো</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be loaded here dynamically -->
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" style="text-align:right;">সর্বমোট:</td>
            <td id="overallSubtotal">0</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  
  <!-- Data Entry Modal -->
  <div id="dataModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalLoading" class="modal-loading" style="display:none;">
        <div class="spinner"></div>
      </div>
      <h2 id="modalTitle">ডেটা এন্ট্রি ফর্ম</h2>
      <form id="entryForm">
        <input type="hidden" id="entryId" name="entryId" value="">
        
        <label for="date">তারিখ:</label>
        <input type="date" id="date" name="date" required>
        
        <label for="orderNo">অর্ডার নং:</label>
        <input type="text" id="orderNo" name="orderNo" required>
        
        <!-- Party Name with datalist suggestions -->
        <label for="partyName">পার্টি নাম:</label>
        <input type="text" id="partyName" name="partyName" list="partyNames" required>
        <datalist id="partyNames">
          <option value="DELUXE APPARELS LTD.">
          <option value="TROUSER WORLD (PVT ) LTD.">
          <option value="CIRCULAR FASHION INDUSTRIES LIMITED">
          <option value="NPM APPARELS LTD.">
          <option value="SHIRT AND JACKET ZONE LTD.">
          <option value="AB APPARELS LTD.">
          <option value="UNIFORM TEXTILE LTD.">
          <option value="BALAKA STITCH (PVT) LTD.">
          <option value="ZAS APPARELS (PVT.) LTD">
          <option value="RBSR FASHIONS LTD.">
          <option value="SMEE APPARELS LTD.">
          <option value="RAM APPAREL LTD">
          <option value="MAJUMDER GARMENTS LTD.">
          <option value="ALIF CASUAL WEAR LIMITED">
          <option value="CORETEX APPARELS LTD.">
          <option value="SUSUKA KNIT LTD.">
          <option value="LAKHSMA INNERWEAR LTD.">
          <option value="SEACOTEX FABRICS LTD.">
          <option value="RICH COTTON APPAREL LTD.">
          <option value="ROWA FASHIONS LTD.">
          <option value="EURO DENIM & FASHION LTD.">
          <option value="ALIF INDUSTRIES LTD.">
          <option value="ZALO KNITTING LTD.">
          <option value="NIPPON GARMENT INDUSTRIES LTD">
          <option value="KC BOTTOM AND SHIRT WEAR COMPANY">
          <option value="GLOBAL FASHION GARMENTS LIMITED">
          <option value="AMENA PVT.LTD.">
          <option value="APICAL INDUSTRIES LTD.">
          <option value="TOP MOON FASHION LTD.">
          <option value="NEWAGE APPARELS LTD.">
          <option value="ALI GARMENTS LTD.">
          <option value="KC JACKET WEAR COMPANY">
          <option value="ALLIANCE KNIT COMPOSITE LTD.">
          <option value="AR JEANS PRODUCER LTD.">
          <option value="VIRTUAL BOTTOMS LTD.">
          <option value="IDAS FASHION LTD.">
          <option value="DAY APPARELS LTD.">
          <option value="SELINA APPARELS LTD.">
          <option value="SPOTFAME APPARELS LTD">
          <option value="SAJIB FASHION WEAR LTD.">
          <option value="EURO ARTE APPARELS LTD.">
          <option value="MANEL FASHION LIMITED">
          <option value="NIPA FASHION WEAR IND LTD.">
          <option value="IMPRESSION SOURCING & DESIGN LTD">
          <option value="MOSTAFA GARMENTS INDUSTRES LTD.">
          <option value="CONCORD RAIMENT WEAR LTD.">
          <option value="AYASHA AND GALEYA FASHIONS LTD.">
          <option value="CELEBRITY EXPORT GARMENTS LTD.">
          <option value="SWAN JEANS LTD.">
          <option value="BELLISSIMA APPARELS LTD.">
          <option value="EHSAN GARMENTS LTD.">
          <option value="DHAKA GARMENTS AND WASHING LTD.">
          <option value="LOGOS APPARELS LTD.">
          <option value="GARMENTS EXPORT VILLAGE LTD.">
          <option value="A & A TROUSERS LTD.">
          <option value="AUTHENTIC GARMENTS (PVT) LIMITED">
          <option value="TIVOLI APPARELS LTD.">
          <option value="ORIENT FASHION LIMITED">
          <option value="A.J. SUPER GARMENTS LTD.">
          <option value="DESIGNER FASHION LIMITED">
          <option value="DOREEN APPARALS LTD">
          <option value="SP GARMENTS LTD.">
          <option value="NATURAL DENIMS LTD.">
          <option value="POWER VANTAGE WEAR LTD.">
          <option value="ROBINTEX(BANGLADESH) LIMITED">
          <option value="JB TEX BD.">
          <option value="EPOCH GARMENTS LTD.">
          <option value="AMEX KNITTING & DYEING INDUSTRIES LTD.">
          <option value="TEMAKAW FASHION  LIMITED.">
          <option value="EUROZONE FASHION LTD.">
          <option value="MORAL FASHIONS LTD.">
          <option value="YAGI BANGLADESH GARMENTS LTD.">
          <option value="VALMONT FASHIONS LTD.">
          <option value="RIVERSTAR FASHION WEAR LIMITED">
          <option value="FARDAR FASHIONS LTD.">
          <option value="NASSA BASICS LTD">
          <option value="TOP STAR FASHIONS LTD.">
          <option value="MOONLIGHT GARMENTS  LTD.">
          <option value="MURAD APPARELS LTD.">
          <option value="PAKIZA KNIT COMPOSITE LTD.">
          <option value="RIO DESIGN LTD.">
          <option value="DAY FASHIONS LTD">
          <option value="BRAVO APPAREL MANUFACTURER LTD">
          <option value="HAMID TEX FASHION LTD.">
          <option value="KIMS CORPORATION LTD">
          <option value="TUNIC APPARELS LTD.">
          <option value="ASPIRE GARMENTS LTD">
          <option value="QUAZI ABEDIN TEX LTD.">
          <option value="A PLUS INDUSTRIES LIMITED.">
          <option value="DRESSMEN FASHION WEAR LTD.">
          <option value="VERSATILE APPAREL PVT LTD.">
          <option value="MOMO FASHIONS LTD.">
          <option value="IMPRESSION DESIGN">
          <option value="PLATINUM APPAREL MANUFACTURING COMPANY LTD.">
          <option value="FASHION EXPORT INTERNATIONAL LTD.">
          <option value="TARASIMA APPARELS LIMITED">
          <option value="PATRIOT ECO APPARELS LTD">
          <option value="SEHA APPARELS INTERNATIONAL LIMITED">
          <option value="MAHADI FASHION ( PVT) LTD.">
          <option value="RIO FASHION WEAR LTD">
          <option value="TEX TECH CO. LTD">
          <option value="AJ FASHIONS LTD.">
          <option value="MEGHNA DENIMS LTD.">
          <option value="BANGA FASHION LTD">
          <option value="S2L FASHIONS (PVT.) LTD.">
          <option value="DOREEN GARMENTS LIMITED">
          <option value="MAHMUD FASHION LTD.">
          <option value="DIPS APPAREL LTD.">
        </datalist>
        
        <label for="colorName">কালার নাম:</label>
        <input type="text" id="colorName" name="colorName" required>
        
        <!-- Count Radio Buttons (১, ২, ৩, ৪ কাউন্ট) -->
        <div class="count-radio-group" style="margin-top:10px; display:flex; align-items:center; gap:20px;">
          <span>কাউন্ট কতটি নির্বাচন করবেন?</span>
          <label for="count1Radio">
            <input type="radio" name="countRadio" value="1" id="count1Radio"> ১ কাউন্ট
          </label>
          <label for="count2Radio">
            <input type="radio" name="countRadio" value="2" id="count2Radio"> ২ কাউন্ট
          </label>
          <label for="count3Radio">
            <input type="radio" name="countRadio" value="3" id="count3Radio"> ৩ কাউন্ট
          </label>
          <label for="count4Radio">
            <input type="radio" name="countRadio" value="4" id="count4Radio"> ৪ কাউন্ট
          </label>
        </div>
        
        <!-- Dynamic Count Rows with Plain Dropdowns -->
        <div id="countRows" style="margin:10px 0;">
          <!-- Row 1 -->
          <div id="row1" class="count-row" style="display:none;">
            <label>Count (১):</label>
            <select id="countVal1">
              <option value="">-- নির্বাচন করুন --</option>
              <option value="50/2">50/2</option>
              <option value="40/2">40/2</option>
              <option value="40/3">40/3</option>
              <option value="20/2">20/2</option>
              <option value="20/3">20/3</option>
              <option value="20/4">20/4</option>
              <option value="20/6">20/6</option>
              <option value="20/9">20/9</option>
              <option value="30/3">30/3</option>
              <option value="150/D">150/D</option>
              <option value="300/D">300/D</option>
              <option value="60/3">60/3</option>
            </select>
            <label>QTY:</label>
            <input type="number" id="qty1" min="0" />
          </div>
          <!-- Row 2 -->
          <div id="row2" class="count-row" style="display:none;">
            <label>Count (২):</label>
            <select id="countVal2">
              <option value="">-- নির্বাচন করুন --</option>
              <option value="50/2">50/2</option>
              <option value="40/2">40/2</option>
              <option value="40/3">40/3</option>
              <option value="20/2">20/2</option>
              <option value="20/3">20/3</option>
              <option value="20/4">20/4</option>
              <option value="20/6">20/6</option>
              <option value="20/9">20/9</option>
              <option value="30/3">30/3</option>
              <option value="150/D">150/D</option>
              <option value="300/D">300/D</option>
              <option value="60/3">60/3</option>
            </select>
            <label>QTY:</label>
            <input type="number" id="qty2" min="0" />
          </div>
          <!-- Row 3 -->
          <div id="row3" class="count-row" style="display:none;">
            <label>Count (৩):</label>
            <select id="countVal3">
              <option value="">-- নির্বাচন করুন --</option>
              <option value="50/2">50/2</option>
              <option value="40/2">40/2</option>
              <option value="40/3">40/3</option>
              <option value="20/2">20/2</option>
              <option value="20/3">20/3</option>
              <option value="20/4">20/4</option>
              <option value="20/6">20/6</option>
              <option value="20/9">20/9</option>
              <option value="30/3">30/3</option>
              <option value="150/D">150/D</option>
              <option value="300/D">300/D</option>
              <option value="60/3">60/3</option>
            </select>
            <label>QTY:</label>
            <input type="number" id="qty3" min="0" />
          </div>
          <!-- Row 4 -->
          <div id="row4" class="count-row" style="display:none;">
            <label>Count (৪):</label>
            <select id="countVal4">
              <option value="">-- নির্বাচন করুন --</option>
              <option value="50/2">50/2</option>
              <option value="40/2">40/2</option>
              <option value="40/3">40/3</option>
              <option value="20/2">20/2</option>
              <option value="20/3">20/3</option>
              <option value="20/4">20/4</option>
              <option value="20/6">20/6</option>
              <option value="20/9">20/9</option>
              <option value="30/3">30/3</option>
              <option value="150/D">150/D</option>
              <option value="300/D">300/D</option>
              <option value="60/3">60/3</option>
            </select>
            <label>QTY:</label>
            <input type="number" id="qty4" min="0" />
          </div>
        </div>
        
        <label for="remarks">রেমার্কস:</label>
        <textarea id="remarks" name="remarks"></textarea>
        
        <!-- Photo Input Wrapper -->
        <div class="photo-input-wrapper">
          <div class="mobile-only">
            <button type="button" id="cameraBtn" title="ক্যামেরা থেকে ছবি তুলুন">📷</button>
            <input type="file" id="photoCamera" name="photoCamera" accept="image/*" capture="environment" style="display: none;">
          </div>
          <label for="photoFile">ফটো (ফাইল নির্বাচন):</label>
          <input type="file" id="photoFile" name="photoFile" accept="image/*">
        </div>
        <button type="submit" id="submitBtn">সেভ করুন</button>
      </form>
    </div>
  </div>
  
  <!-- Photo Preview Modal -->
  <div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
      <span id="closePhotoModal" class="close-photo">&times;</span>
      <div id="photoSpinner">
        <div class="spinner"></div>
      </div>
      <img id="modalImg" src="" alt="Full View">
    </div>
  </div>
  
  <!-- Modify Modal with Nested Action Modal -->
  <div id="modifyModal" class="modal modify-modal">
    <div class="modal-content" id="modifyModalContent">
      <span class="close" id="closeModifyModal">&times;</span>
      <h2>মডিফাই</h2>
      <label for="orderSearchSelect">অর্ডার নির্বাচন করুন:</label>
      <!-- Order search dropdown using Select2 -->
      <select id="orderSearchSelect" style="width:100%"></select>
      <button id="searchOrderBtn">সার্চ করুন</button>
      <div id="modifyResults" style="margin-top:15px;"></div>
    </div>
    <!-- Nested Action Modal -->
    <div id="actionModal" class="nested-modal">
      <div class="modal-content">
        <span class="close" id="closeActionModal">&times;</span>
        <h2>অ্যাকশন নির্বাচন করুন</h2>
        <button id="actionEditBtn">এডিট</button>
        <button id="actionDeleteBtn" style="background:#d9534f">ডিলেট</button>
      </div>
    </div>
  </div>
  
  <footer>
    <p>© Zubair</p>
  </footer>
  
  <!-- Supabase & Select2 JS (Select2 used only for Order Search) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    // SUPABASE CONFIGURATION
    const SUPABASE_URL = "https://rabjyhlinntzbnbqbmad.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhYmp5aGxpbm50emJuYnFibWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAzNzg2NDAsImV4cCI6MjA1NTk1NDY0MH0.19NyAvpxbG5czIyLmPiRQ26X3R_Wo_cqTurGIUf3hmQ";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Element References
    const advancedFilterSection = document.getElementById("advancedFilterSection");
    const modal = document.getElementById("dataModal");
    const openModalBtn = document.getElementById("openModalBtn");
    const closeModalBtn = document.querySelector("#dataModal .close");
    const entryForm = document.getElementById("entryForm");
    const modalTitle = document.getElementById("modalTitle");
    const submitBtn = document.getElementById("submitBtn");
    const entryIdField = document.getElementById("entryId");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const modalLoading = document.getElementById("modalLoading");
    const photoModal = document.getElementById("photoModal");
    const closePhotoModal = document.getElementById("closePhotoModal");
    const modalImg = document.getElementById("modalImg");
    const photoSpinner = document.getElementById("photoSpinner");
    const filterDate = document.getElementById("filterDate");
    const filterOrderNo = document.getElementById("filterOrderNo");
    const filterSeedNo = document.getElementById("filterSeedNo");
    const toggleFilterBtn = document.getElementById("toggleFilterBtn");
    let isFilterOpen = false;
    
    // Count Radios & Rows
    const count1Radio = document.getElementById("count1Radio");
    const count2Radio = document.getElementById("count2Radio");
    const count3Radio = document.getElementById("count3Radio");
    const count4Radio = document.getElementById("count4Radio");
    const row1 = document.getElementById("row1");
    const row2 = document.getElementById("row2");
    const row3 = document.getElementById("row3");
    const row4 = document.getElementById("row4");
    
    // Modify Modal & Order Search Select (Select2 used here)
    const modifyModal = document.getElementById("modifyModal");
    const modifyBtn = document.getElementById("modifyBtn");
    const closeModifyModal = document.getElementById("closeModifyModal");
    const orderSearchSelect = document.getElementById("orderSearchSelect");
    
    // Advanced Filter Toggle
    toggleFilterBtn.addEventListener("click", () => {
      isFilterOpen = !isFilterOpen;
      advancedFilterSection.classList.toggle("active", isFilterOpen);
    });
    
    // Data Entry Modal Handling
    openModalBtn.addEventListener("click", () => {
      setFormMode("new");
      modal.classList.add("show");
    });
    closeModalBtn.addEventListener("click", () => { modal.classList.remove("show"); });
    window.addEventListener("click", (e) => { if (e.target === modal) { modal.classList.remove("show"); } });
    
    // Print Button
    document.getElementById("printBtn").addEventListener("click", () => { window.print(); });
    
    // Toast Message
    function showToast(message, type="success") {
      const toast = document.createElement("div");
      toast.classList.add("toast");
      if(type === "error") { toast.classList.add("error"); }
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add("show"); }, 100);
      setTimeout(() => { toast.classList.remove("show"); setTimeout(() => { toast.remove(); }, 300); }, 3000);
    }
    
    // Loading Functions
    function showLoading() { loadingOverlay.classList.add("show"); }
    function hideLoading() { loadingOverlay.classList.remove("show"); }
    function showModalLoading() { modalLoading.style.display = "flex"; }
    function hideModalLoading() { modalLoading.style.display = "none"; }
    
    // Debounce Function
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      }
    }
    
    // Count Radio Change: Show/Hide Rows
    document.querySelectorAll('input[name="countRadio"]').forEach(radio => {
      radio.addEventListener("change", (e) => {
        const val = e.target.value;
        row1.style.display = "none";
        row2.style.display = "none";
        row3.style.display = "none";
        row4.style.display = "none";
        if(val === "1") { row1.style.display = "flex"; }
        else if(val === "2") { row1.style.display = "flex"; row2.style.display = "flex"; }
        else if(val === "3") { row1.style.display = "flex"; row2.style.display = "flex"; row3.style.display = "flex"; }
        else if(val === "4") { row1.style.display = "flex"; row2.style.display = "flex"; row3.style.display = "flex"; row4.style.display = "flex"; }
      });
    });
    
    // (Count dropdowns remain as plain <select> elements; no Select2 init for these)
    
    // Initialize Select2 for Order Search in Modify Modal
    function initOrderSearchSelect(options) {
      $(orderSearchSelect).empty().select2({
        placeholder: "অর্ডার নির্বাচন করুন",
        data: options,
        width: 'resolve',
        allowClear: true
      });
    }
    
    // Image Upload Function
    async function uploadImage(file) {
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random().toString(36).substr(2, 9)}_${Date.now()}.${fileExt}`;
        const { data, error: uploadError } = await supabaseClient.storage.from('photos').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: { publicUrl } } = await supabaseClient.storage.from('photos').getPublicUrl(data.path);
        return publicUrl;
      } catch (error) {
        console.error('Upload error:', error);
        showToast(`ফটো আপলোড ব্যর্থ: ${error.message}`, "error");
        return null;
      }
    }
    
    // Form Submission (Insert or Update)
    entryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      showModalLoading();
      const idVal = entryIdField.value;
      const dateVal = document.getElementById("date").value;
      const orderNoVal = document.getElementById("orderNo").value;
      const partyNameVal = document.getElementById("partyName").value;
      const seedNoVal = document.getElementById("seedNo").value;
      const colorNameVal = document.getElementById("colorName").value;
      const remarksVal = document.getElementById("remarks").value;
      
      const photoCameraFile = document.getElementById("photoCamera").files[0];
      const photoFileInput = document.getElementById("photoFile").files[0];
      const selectedFile = photoCameraFile || photoFileInput;
      let photoUrl = null;
      if (selectedFile) {
        photoUrl = await uploadImage(selectedFile);
        if (!photoUrl) { hideModalLoading(); return; }
      }
      
      let selectedCountRadio = document.querySelector('input[name="countRadio"]:checked');
      if(!selectedCountRadio) {
        hideModalLoading();
        showToast("কাউন্ট কতটি হবে, নির্বাচন করুন!", "error");
        return;
      }
      let selectedCount = parseInt(selectedCountRadio.value, 10);
      
      let countsData = [];
      if(selectedCount >= 1) {
        const c1 = document.getElementById("countVal1").value;
        const q1 = document.getElementById("qty1").value;
        countsData.push({ count: c1, qty: q1 });
      }
      if(selectedCount >= 2) {
        const c2 = document.getElementById("countVal2").value;
        const q2 = document.getElementById("qty2").value;
        countsData.push({ count: c2, qty: q2 });
      }
      if(selectedCount >= 3) {
        const c3 = document.getElementById("countVal3").value;
        const q3 = document.getElementById("qty3").value;
        countsData.push({ count: c3, qty: q3 });
      }
      if(selectedCount >= 4) {
        const c4 = document.getElementById("countVal4").value;
        const q4 = document.getElementById("qty4").value;
        countsData.push({ count: c4, qty: q4 });
      }
      
      let error;
      if(!idVal) {
        ({ error } = await supabaseClient.from('data_entries').insert([{
           date: dateVal,
           order_no: orderNoVal,
           party_name: partyNameVal,
           seed_no: seedNoVal,
           color_name: colorNameVal,
           remarks: remarksVal,
           photo_url: photoUrl,
           counts_data: countsData
        }]));
      } else {
        let updateData = {
           date: dateVal,
           order_no: orderNoVal,
           party_name: partyNameVal,
           seed_no: seedNoVal,
           color_name: colorNameVal,
           remarks: remarksVal,
           counts_data: countsData
        };
        if(photoUrl) { updateData.photo_url = photoUrl; }
        ({ error } = await supabaseClient.from('data_entries').update(updateData).eq('id', idVal));
      }
      hideModalLoading();
      if (error) {
        showToast("ডেটা সংরক্ষণে সমস্যা: " + error.message, "error");
      } else {
        showToast("ডেটা সফলভাবে সংরক্ষণ হয়েছে");
        modal.classList.remove("show");
        entryForm.reset();
        resetCountRows();
        loadData();
      }
    });
    
    function resetCountRows() {
      document.querySelectorAll('input[name="countRadio"]').forEach(r => r.checked = false);
      row1.style.display = "none";
      row2.style.display = "none";
      row3.style.display = "none";
      row4.style.display = "none";
      document.getElementById("countVal1").value = "";
      document.getElementById("qty1").value = "";
      document.getElementById("countVal2").value = "";
      document.getElementById("qty2").value = "";
      document.getElementById("countVal3").value = "";
      document.getElementById("qty3").value = "";
      document.getElementById("countVal4").value = "";
      document.getElementById("qty4").value = "";
    }
    
    function setFormMode(mode, entry=null) {
      if(mode === "new") {
        modalTitle.innerText = "ডেটা এন্ট্রি ফর্ম";
        submitBtn.innerText = "সেভ করুন";
        entryIdField.value = "";
        entryForm.reset();
        resetCountRows();
      } else if(mode === "edit" && entry) {
        modalTitle.innerText = "ডেটা এডিট ফর্ম";
        submitBtn.innerText = "আপডেট করুন";
        entryIdField.value = entry.id || "";
        document.getElementById("date").value = entry.date || "";
        document.getElementById("orderNo").value = entry.order_no || "";
        document.getElementById("partyName").value = entry.party_name || "";
        document.getElementById("seedNo").value = entry.seed_no || "";
        document.getElementById("colorName").value = entry.color_name || "";
        document.getElementById("remarks").value = entry.remarks || "";
        resetCountRows();
        if(entry.counts_data && Array.isArray(entry.counts_data)) {
          let length = entry.counts_data.length;
          if(length === 1) { count1Radio.checked = true; row1.style.display = "flex"; }
          else if(length === 2) { count2Radio.checked = true; row1.style.display = "flex"; row2.style.display = "flex"; }
          else if(length === 3) { count3Radio.checked = true; row1.style.display = "flex"; row2.style.display = "flex"; row3.style.display = "flex"; }
          else if(length === 4) { count4Radio.checked = true; row1.style.display = "flex"; row2.style.display = "flex"; row3.style.display = "flex"; row4.style.display = "flex"; }
          if(entry.counts_data[0]) {
            document.getElementById("countVal1").value = entry.counts_data[0].count || "";
            document.getElementById("qty1").value = entry.counts_data[0].qty || "";
          }
          if(entry.counts_data[1]) {
            document.getElementById("countVal2").value = entry.counts_data[1].count || "";
            document.getElementById("qty2").value = entry.counts_data[1].qty || "";
          }
          if(entry.counts_data[2]) {
            document.getElementById("countVal3").value = entry.counts_data[2].count || "";
            document.getElementById("qty3").value = entry.counts_data[2].qty || "";
          }
          if(entry.counts_data[3]) {
            document.getElementById("countVal4").value = entry.counts_data[3].count || "";
            document.getElementById("qty4").value = entry.counts_data[3].qty || "";
          }
        }
      }
    }
    
    async function editEntry(id) {
      showLoading();
      const { data, error } = await supabaseClient.from('data_entries').select('*').eq('id', id).single();
      hideLoading();
      if(error || !data) {
        showToast("ডেটা লোডে সমস্যা বা এন্ট্রি পাওয়া যায়নি", "error");
        return;
      }
      setFormMode("edit", data);
      modal.classList.add("show");
    }
    async function deleteEntry(id) {
      const sure = confirm("আপনি কি নিশ্চিতভাবে ডিলিট করতে চান?");
      if(!sure) return;
      showLoading();
      const { error } = await supabaseClient.from('data_entries').delete().eq('id', id);
      hideLoading();
      if(error) {
        showToast("ডিলিট করতে সমস্যা হয়েছে: " + error.message, "error");
      } else {
        showToast("সফলভাবে ডিলিট হয়েছে");
        loadData();
      }
    }
    
    function formatDate(dateStr) {
      let date = new Date(dateStr);
      if(isNaN(date)) return '-';
      let day = date.getDate();
      let month = date.getMonth() + 1;
      let year = date.getFullYear();
      return (day < 10 ? "0" + day : day) + "-" + (month < 10 ? "0" + month : month) + "-" + year;
    }
    
    async function loadData(skipLoading = false) {
      if(!skipLoading) showLoading();
      let query = supabaseClient.from('data_entries').select('*').order('id', { ascending: false });
      const dateVal = filterDate.value;
      const orderNoVal = filterOrderNo.value.trim();
      const seedNoVal = filterSeedNo.value.trim();
      if (dateVal) { query = query.eq('date', dateVal); }
      if (orderNoVal) { query = query.ilike('order_no', `%${orderNoVal}%`); }
      if (seedNoVal) { query = query.ilike('seed_no', `%${seedNoVal}%`); }
      const { data, error } = await query;
      if(!skipLoading) hideLoading();
      if (error) { showToast("ডেটা লোডে সমস্যা: " + error.message, "error"); return; }
      const tbody = document.getElementById("dataTable").querySelector("tbody");
      tbody.innerHTML = "";
      let overallTotal = 0;
      data.forEach(entry => {
        let formattedDate = formatDate(entry.date);
        let countDisplay = "-";
        if(entry.counts_data && Array.isArray(entry.counts_data) && entry.counts_data.length > 0) {
          const lines = entry.counts_data.map(cd => `${cd.count || '-'} = ${cd.qty || '0'}`);
          const total = entry.counts_data.reduce((sum, cd) => sum + Number(cd.qty || 0), 0);
          overallTotal += total;
          countDisplay = lines.join("<br>") + "<br>____________<br>টোটাল = " + total;
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formattedDate}</td>
          <td>${entry.order_no || '-'}</td>
          <td>${entry.party_name || '-'}</td>
          <td>${entry.seed_no || '-'}</td>
          <td>${entry.color_name || '-'}</td>
          <td>${countDisplay}</td>
          <td>${entry.remarks || '-'}</td>
          <td>${ entry.photo_url ? `<img src="${entry.photo_url}" width="50" alt="ফটো" class="preview-img">` : '-' }</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("overallSubtotal").innerText = overallTotal;
      attachImagePreviewEvents();
    }
    
    let currentScale = 1, translateX = 0, translateY = 0;
    let isDragging = false, dragStartX = 0, dragStartY = 0;
    function resetTransform() {
      currentScale = 1;
      translateX = 0;
      translateY = 0;
      modalImg.style.transform = "translate(0px, 0px) scale(1)";
    }
    function attachImagePreviewEvents() {
      const images = document.querySelectorAll(".preview-img");
      images.forEach(img => {
        img.addEventListener("click", (e) => {
          photoSpinner.style.display = "block";
          modalImg.src = e.target.src;
          resetTransform();
          modalImg.onload = () => { photoSpinner.style.display = "none"; };
          photoModal.classList.add("show");
        });
      });
    }
    window.addEventListener("keydown", function(e) {
      if(photoModal.classList.contains("show") && e.ctrlKey){
        if(e.key === '+' || e.key === '='){
          currentScale += 0.1;
          modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
          e.preventDefault();
        } else if(e.key === '-'){
          currentScale = Math.max(1, currentScale - 0.1);
          modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
          e.preventDefault();
        }
      }
    });
    modalImg.addEventListener("mousedown", function(e) {
      isDragging = true;
      dragStartX = e.clientX - translateX;
      dragStartY = e.clientY - translateY;
    });
    window.addEventListener("mousemove", function(e) {
      if(isDragging) {
        translateX = e.clientX - dragStartX;
        translateY = e.clientY - dragStartY;
        modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
      }
    });
    window.addEventListener("mouseup", function(e) {
      isDragging = false;
    });
    let initialDistance = null, initialScale = 1;
    modalImg.addEventListener("touchstart", function(e) {
      if(e.touches.length === 2){
        initialDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        initialScale = currentScale;
      } else if(e.touches.length === 1){
        isDragging = true;
        dragStartX = e.touches[0].clientX - translateX;
        dragStartY = e.touches[0].clientY - translateY;
      }
    });
    modalImg.addEventListener("touchmove", function(e) {
      if(e.touches.length === 2 && initialDistance){
        let newDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        currentScale = Math.max(1, initialScale * (newDistance / initialDistance));
        modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        e.preventDefault();
      } else if(e.touches.length === 1 && isDragging){
        translateX = e.touches[0].clientX - dragStartX;
        translateY = e.touches[0].clientY - dragStartY;
        modalImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        e.preventDefault();
      }
    });
    modalImg.addEventListener("touchend", function(e) {
      if(e.touches.length < 2){ initialDistance = null; }
      if(e.touches.length === 0){ isDragging = false; }
    });
    closePhotoModal.addEventListener("click", (e) => {
      e.stopPropagation();
      photoModal.classList.remove("show");
    });
    const debouncedLoadData = debounce((skip) => { loadData(skip); }, 300);
    filterDate.addEventListener("change", () => { loadData(); });
    filterOrderNo.addEventListener("input", () => { debouncedLoadData(true); });
    filterSeedNo.addEventListener("input", () => { debouncedLoadData(true); });
    window.addEventListener("load", () => { 
      loadData(); 
    });
    
    // Modify Modal: Order Search using Select2
    modifyBtn.addEventListener("click", async () => {
      modifyModal.classList.add("show");
      showLoading();
      // Fetch unique order numbers
      const { data, error } = await supabaseClient.from('data_entries').select('order_no');
      hideLoading();
      if(error) { showToast("অর্ডার লোডে সমস্যা: " + error.message, "error"); return; }
      const uniqueOrders = [...new Set(data.map(o => o.order_no))];
      const options = uniqueOrders.map(order => ({ id: order, text: order }));
      initOrderSearchSelect(options);
    });
    closeModifyModal.addEventListener("click", () => { modifyModal.classList.remove("show"); });
    window.addEventListener("click", (e) => { if(e.target === modifyModal) { modifyModal.classList.remove("show"); } });
    
    // Modify Modal: Search Order Button Click
    document.getElementById("searchOrderBtn").addEventListener("click", async () => {
      const selectedOrder = $(orderSearchSelect).val();
      if(!selectedOrder) {
        showToast("অনুগ্রহ করে অর্ডার নির্বাচন করুন", "error");
        return;
      }
      showLoading();
      const { data, error } = await supabaseClient.from('data_entries').select('*').ilike('order_no', `%${selectedOrder}%`);
      hideLoading();
      const resultsDiv = document.getElementById("modifyResults");
      resultsDiv.innerHTML = "";
      if(error) {
        resultsDiv.innerHTML = "<p>ডেটা লোডে সমস্যা: " + error.message + "</p>";
        return;
      }
      if(data.length === 0) {
        resultsDiv.innerHTML = "<p>কোনও ডেটা পাওয়া যায়নি</p>";
        return;
      }
      let html = '<div style="overflow:auto;"><table style="width:100%; border-collapse:collapse;">';
      html += '<thead><tr style="background:#fda085; color:#fff;">';
      html += '<th>তারিখ</th><th>অর্ডার নং</th><th>পার্টি নাম</th><th>সেড নং</th><th>কালার নাম</th><th>কাউন্ট &amp; QTY</th><th>রেমার্কস</th><th>ফটো</th><th>অ্যাকশন</th>';
      html += '</tr></thead><tbody>';
      data.forEach(entry => {
        let formattedDate = formatDate(entry.date);
        let countDisplay = "-";
        if(entry.counts_data && Array.isArray(entry.counts_data) && entry.counts_data.length > 0) {
          const lines = entry.counts_data.map(cd => `${cd.count || '-'} = ${cd.qty || '0'}`);
          const total = entry.counts_data.reduce((sum, cd) => sum + Number(cd.qty || 0), 0);
          countDisplay = lines.join("<br>") + "<br>____________<br>টোটাল = " + total;
        }
        html += `<tr style="border:1px solid #ddd; padding:8px;">
          <td>${formattedDate}</td>
          <td>${entry.order_no || '-'}</td>
          <td>${entry.party_name || '-'}</td>
          <td>${entry.seed_no || '-'}</td>
          <td>${entry.color_name || '-'}</td>
          <td>${countDisplay}</td>
          <td>${entry.remarks || '-'}</td>
          <td>${ entry.photo_url ? `<img src="${entry.photo_url}" width="50" alt="ফটো" class="preview-img">` : '-' }</td>
          <td style="text-align:center; cursor:pointer;" onclick="openNestedActionModal(${entry.id})">☰</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      resultsDiv.innerHTML = html;
      attachImagePreviewEvents();
    });
    
    let currentActionId = null;
    function openNestedActionModal(id) {
      currentActionId = id;
      document.getElementById("actionModal").classList.add("show");
    }
    document.getElementById("closeActionModal").addEventListener("click", () => {
      document.getElementById("actionModal").classList.remove("show");
    });
    document.getElementById("actionEditBtn").addEventListener("click", () => {
      document.getElementById("actionModal").classList.remove("show");
      modifyModal.classList.remove("show");
      editEntry(currentActionId);
    });
    document.getElementById("actionDeleteBtn").addEventListener("click", () => {
      document.getElementById("actionModal").classList.remove("show");
      modifyModal.classList.remove("show");
      deleteEntry(currentActionId);
    });
    
    document.getElementById("cameraBtn").addEventListener("click", () => {
      document.getElementById("photoCamera").click();
    });
  </script>
</body>
</html>
