<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ডেটা এন্ট্রি সাইট</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* CSS Variables for Colors & Fonts */
    :root {
      --primary-color: #4e54c8;
      --secondary-color: #8f94fb;
      --accent-color: #ff6f61;
      --bg-color: #f7f7f7;
      --text-color: #333;
      --modal-bg: #ffffff;
      --transition-speed: 0.3s;
    }

    /* Global Reset & Base Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      padding: 20px;
      text-align: center;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      animation: slideDown 0.5s ease-out;
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 15px;
    }

    /* Top Controls */
    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .top-controls button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px 25px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 500;
      transition: background var(--transition-speed);
    }
    .top-controls button:hover {
      background: var(--accent-color);
    }

    /* Filter Area */
    .filter-area {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    .filter-area label { font-weight: 500; }
    .filter-area input,
    .filter-area select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
      transition: border-color var(--transition-speed);
    }
    .filter-area input:focus,
    .filter-area select:focus { border-color: var(--primary-color); }

    /* Advanced Filter Collapsible */
    .advanced-filter-toggle {
      background: var(--primary-color);
      padding: 10px 18px;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background var(--transition-speed);
    }
    .advanced-filter-toggle:hover { background: var(--accent-color); }
    .advanced-filter {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 10px;
      display: none;
      flex-wrap: wrap;
      gap: 15px;
      animation: fadeIn 0.4s ease;
    }
    .advanced-filter.active { display: flex; }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Table Styles */
    .table-container {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table thead tr {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: #fff;
    }
    table th,
    table td {
      padding: 14px 20px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9rem;
    }
    table tbody tr:nth-child(even) { background: #f2f2f2; }
    table tbody tr:hover { background: #e9e9ff; }
    table img { border-radius: 4px; cursor: pointer; transition: transform var(--transition-speed); }
    table img:hover { transform: scale(1.05); }

    /* Modals */
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 1000;
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: var(--modal-bg);
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      padding: 25px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      animation: popIn 0.5s ease;
    }
    /* Make Modify Modal scrollable */
    #modifyModal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    @keyframes popIn {
      from { transform: scale(0.7); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-content h2 { margin-bottom: 20px; text-align: center; color: var(--primary-color); }
    .modal-content .close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 28px;
      cursor: pointer;
      color: #888;
      transition: color 0.3s;
    }
    .modal-content .close:hover { color: var(--accent-color); }
    .modal-loading {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      border-radius: 10px;
    }

    /* Form Styles */
    form label { margin-top: 10px; display: block; font-weight: 500; }
    form input,
    form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
      transition: border-color var(--transition-speed);
    }
    form input:focus,
    form textarea:focus { border-color: var(--primary-color); }
    form button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1rem;
      transition: background var(--transition-speed);
      width: 100%;
    }
    form button:hover { background: var(--accent-color); }

    /* Photo Modal */
    .photo-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 2000;
    }
    .photo-modal.show { opacity: 1; pointer-events: auto; }
    .photo-modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }
    .photo-modal-content img {
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    .photo-modal .close-photo {
      position: absolute;
      top: -35px;
      right: 0;
      color: #fff;
      font-size: 32px;
      cursor: pointer;
    }

    /* Toast Message */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary-color);
      color: #fff;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.4s, transform 0.4s;
      z-index: 3000;
      pointer-events: none;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.error { background: #d9534f; }

    /* Global Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.show { opacity: 1; pointer-events: auto; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .top-controls { flex-direction: column; }
      table th, table td { padding: 10px 15px; font-size: 0.85rem; }
      .modal-content { width: 95%; }
    }

    /* Print Styles: Only show table area */
    @media print {
      body * { visibility: hidden; }
      .table-container, .table-container * { visibility: visible; }
      .table-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ডেটা এন্ট্রি সাইট</h1>
  </header>

  <!-- Global Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <!-- Top Controls -->
    <div class="top-controls">
      <button id="openModalBtn">ডেটা এন্ট্রি করুন</button>
      <button id="modifyBtn">মডিফাই</button>
      <button id="printBtn">প্রিন্ট</button>
    </div>

    <!-- Filter Area -->
    <div class="filter-area">
      <div>
        <label for="filterOrderNo">অর্ডার নং</label>
        <input type="text" id="filterOrderNo" placeholder="অর্ডার নং">
      </div>
      <div>
        <button class="advanced-filter-toggle" id="toggleFilterBtn">অ্যাডভান্সড ফিল্টার</button>
      </div>
    </div>

    <!-- Advanced Filter Collapsible -->
    <div class="advanced-filter" id="advancedFilterSection">
      <div>
        <label for="filterDate">তারিখ</label>
        <input type="date" id="filterDate">
      </div>
      <div>
        <label for="filterMonth">মাস</label>
        <select id="filterMonth">
          <option value="">-- নির্বাচন করুন --</option>
          <option value="01">জানুয়ারি</option>
          <option value="02">ফেব্রুয়ারি</option>
          <option value="03">মার্চ</option>
          <option value="04">এপ্রিল</option>
          <option value="05">মে</option>
          <option value="06">জুন</option>
          <option value="07">জুলাই</option>
          <option value="08">আগস্ট</option>
          <option value="09">সেপ্টেম্বর</option>
          <option value="10">অক্টোবর</option>
          <option value="11">নভেম্বর</option>
          <option value="12">ডিসেম্বর</option>
        </select>
      </div>
      <div>
        <label for="filterYear">বছর</label>
        <input type="number" id="filterYear" placeholder="বছর (যেমন: 2025)">
      </div>
    </div>

    <!-- Main Data Table (অ্যাকশন কলাম নেই) -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>তারিখ</th>
            <th>অর্ডার নং</th>
            <th>পার্টি নাম</th>
            <th>সেড নং</th>
            <th>কালার নাম</th>
            <th>রেমার্কস</th>
          </tr>
        </thead>
        <tbody>
          <!-- ডেটা লোড হবে জাভাস্ক্রিপ্ট থেকে -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Data Entry Modal -->
  <div id="dataModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalLoading" class="modal-loading" style="display:none;">
        <div class="spinner"></div>
      </div>
      <h2 id="modalTitle">ডেটা এন্ট্রি ফর্ম</h2>
      <form id="entryForm">
        <input type="hidden" id="entryId" name="entryId" value="">
        <label for="date">তারিখ:</label>
        <input type="date" id="date" name="date" required>
        <label for="orderNo">অর্ডার নং:</label>
        <input type="text" id="orderNo" name="orderNo" required>
        <label for="partyName">পার্টি নাম:</label>
        <input type="text" id="partyName" name="partyName" required>
        <label for="seedNo">সেড নং:</label>
        <input type="text" id="seedNo" name="seedNo" required>
        <label for="colorName">কালার নাম:</label>
        <input type="text" id="colorName" name="colorName" required>
        <label for="remarks">রেমার্কস:</label>
        <textarea id="remarks" name="remarks"></textarea>
        <label for="photo">ফটো:</label>
        <input type="file" id="photo" name="photo" accept="image/*">
        <button type="submit" id="submitBtn">সেভ করুন</button>
      </form>
    </div>
  </div>

  <!-- Photo Preview Modal -->
  <div id="photoModal" class="photo-modal">
    <div class="photo-modal-content">
      <span id="closePhotoModal" class="close-photo">&times;</span>
      <div id="photoSpinner">
        <div class="spinner"></div>
      </div>
      <img id="modalImg" src="" alt="Full View">
    </div>
  </div>

  <!-- Modify Modal: অর্ডার সার্চ ও এডিট/ডিলিট (Scrollable) -->
  <div id="modifyModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModifyModal">&times;</span>
      <h2>মডিফাই</h2>
      <input type="text" id="modifyOrderNo" placeholder="অর্ডার নং দিয়ে সার্চ করুন" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
      <div class="table-container">
        <table id="modifyTable">
          <thead>
            <tr>
              <th>তারিখ</th>
              <th>অর্ডার নং</th>
              <th>পার্টি নাম</th>
              <th>সেড নং</th>
              <th>কালার নাম</th>
              <th>রেমার্কস</th>
              <th>অ্যাকশন</th>
            </tr>
          </thead>
          <tbody>
            <!-- সার্চকৃত অর্ডারের ডেটা এখানে লোড হবে -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>
    <p>ডেটা এন্ট্রি সাইট © 2025</p>
  </footer>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    //==== Supabase কনফিগারেশন ====
    const SUPABASE_URL = "https://rabjyhlinntzbnbqbmad.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhYmp5aGxpbm50emJuYnFibWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAzNzg2NDAsImV4cCI6MjA1NTk1NDY0MH0.19NyAvpxbG5czIyLmPiRQ26X3R_Wo_cqTurGIUf3hmQ"; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    //==== Elements & Variables ====
    const modal = document.getElementById("dataModal");
    const openModalBtn = document.getElementById("openModalBtn");
    const closeModalBtn = document.querySelector("#dataModal .close");
    const entryForm = document.getElementById("entryForm");
    const modalTitle = document.getElementById("modalTitle");
    const submitBtn = document.getElementById("submitBtn");
    const entryIdField = document.getElementById("entryId");

    const loadingOverlay = document.getElementById("loadingOverlay");
    const modalLoading = document.getElementById("modalLoading");

    //==== Photo Modal Elements ====
    const photoModal = document.getElementById("photoModal");
    const closePhotoModal = document.getElementById("closePhotoModal");
    const modalImg = document.getElementById("modalImg");
    const photoSpinner = document.getElementById("photoSpinner");

    //==== Filters for Main Table ====
    const filterDate = document.getElementById("filterDate");
    const filterMonth = document.getElementById("filterMonth");
    const filterYear = document.getElementById("filterYear");
    const filterOrderNo = document.getElementById("filterOrderNo");

    //==== Advanced Filter Toggle ====
    const toggleFilterBtn = document.getElementById("toggleFilterBtn");
    const advancedFilterSection = document.getElementById("advancedFilterSection");
    let isFilterOpen = false;
    toggleFilterBtn.addEventListener("click", () => {
      isFilterOpen = !isFilterOpen;
      advancedFilterSection.classList.toggle("active", isFilterOpen);
    });

    //==== Data Entry Modal Handling ====
    openModalBtn.addEventListener("click", () => {
      setFormMode("new");
      modal.classList.add("show");
    });
    closeModalBtn.addEventListener("click", () => { modal.classList.remove("show"); });
    window.addEventListener("click", (e) => { if(e.target === modal) modal.classList.remove("show"); });

    //==== Print Functionality ====
    document.getElementById("printBtn").addEventListener("click", () => { window.print(); });

    //==== Toast Message Function ====
    function showToast(message, type="success") {
      const toast = document.createElement("div");
      toast.classList.add("toast");
      if(type === "error") { toast.classList.add("error"); }
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => { toast.classList.add("show"); }, 100);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => { toast.remove(); }, 300);
      }, 3000);
    }

    //==== Global Loading Overlay Functions ====
    function showLoading() { loadingOverlay.classList.add("show"); }
    function hideLoading() { loadingOverlay.classList.remove("show"); }

    //==== Modal Loading Functions ====
    function showModalLoading() { modalLoading.style.display = "flex"; }
    function hideModalLoading() { modalLoading.style.display = "none"; }

    //==== Debounce Function ====
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      }
    }

    //==== Image Upload Function ====
    async function uploadImage(file) {
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random().toString(36).substr(2, 9)}_${Date.now()}.${fileExt}`;
        const { data, error: uploadError } = await supabaseClient.storage
          .from('photos')
          .upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: { publicUrl } } = await supabaseClient.storage
          .from('photos')
          .getPublicUrl(data.path);
        return publicUrl;
      } catch (error) {
        console.error('Upload error:', error);
        showToast(`ফটো আপলোড ব্যর্থ: ${error.message}`, "error");
        return null;
      }
    }
    
    //==== Form Submission (Insert or Update) ====
    entryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      showModalLoading();
      const idVal = entryIdField.value;
      const dateVal = document.getElementById("date").value;
      const orderNoVal = document.getElementById("orderNo").value;
      const partyNameVal = document.getElementById("partyName").value;
      const seedNoVal = document.getElementById("seedNo").value;
      const colorNameVal = document.getElementById("colorName").value;
      const remarksVal = document.getElementById("remarks").value;
      const photoFile = document.getElementById("photo").files[0];
      
      let photoUrl = null;
      if (photoFile) {
        photoUrl = await uploadImage(photoFile);
        if (!photoUrl) { hideModalLoading(); return; }
      }

      let error;
      if(!idVal) {
        ({ error } = await supabaseClient
          .from('data_entries')
          .insert([{ 
            date: dateVal, order_no: orderNoVal, party_name: partyNameVal,
            seed_no: seedNoVal, color_name: colorNameVal, remarks: remarksVal,
            photo_url: photoUrl 
          }]));
      } else {
        let updateData = { 
          date: dateVal, order_no: orderNoVal, party_name: partyNameVal,
          seed_no: seedNoVal, color_name: colorNameVal, remarks: remarksVal 
        };
        if(photoUrl) { updateData.photo_url = photoUrl; }
        ({ error } = await supabaseClient
          .from('data_entries')
          .update(updateData)
          .eq('id', idVal));
      }

      hideModalLoading();
      if (error) {
        showToast("ডেটা সংরক্ষণে সমস্যা: " + error.message, "error");
      } else {
        showToast("ডেটা সফলভাবে সংরক্ষণ হয়েছে");
        modal.classList.remove("show");
        entryForm.reset();
        loadData();
        loadModifyData(); // Refresh modify table if open
      }
    });

    //==== Set Form Mode (New or Edit) ====
    function setFormMode(mode, entry=null) {
      if(mode === "new") {
        modalTitle.innerText = "ডেটা এন্ট্রি ফর্ম";
        submitBtn.innerText = "সেভ করুন";
        entryIdField.value = "";
        entryForm.reset();
      } else if(mode === "edit" && entry) {
        modalTitle.innerText = "ডেটা এডিট ফর্ম";
        submitBtn.innerText = "আপডেট করুন";
        entryIdField.value = entry.id || "";
        document.getElementById("date").value = entry.date || "";
        document.getElementById("orderNo").value = entry.order_no || "";
        document.getElementById("partyName").value = entry.party_name || "";
        document.getElementById("seedNo").value = entry.seed_no || "";
        document.getElementById("colorName").value = entry.color_name || "";
        document.getElementById("remarks").value = entry.remarks || "";
      }
    }

    //==== Edit & Delete Functions ====
    async function editEntry(id) {
      showLoading();
      const { data, error } = await supabaseClient
        .from('data_entries')
        .select('*')
        .eq('id', id)
        .single();
      hideLoading();
      if(error || !data) {
        showToast("ডেটা লোডে সমস্যা বা এন্ট্রি পাওয়া যায়নি", "error");
        return;
      }
      setFormMode("edit", data);
      modal.classList.add("show");
      // Close modify modal if open
      modifyModal.classList.remove("show");
    }

    async function deleteEntry(id) {
      const sure = confirm("আপনি কি নিশ্চিতভাবে ডিলিট করতে চান?");
      if(!sure) return;
      showLoading();
      const { error } = await supabaseClient
        .from('data_entries')
        .delete()
        .eq('id', id);
      hideLoading();
      if(error) {
        showToast("ডিলিট করতে সমস্যা হয়েছে: " + error.message, "error");
      } else {
        showToast("সফলভাবে ডিলিট হয়েছে");
        loadData();
        loadModifyData(); // Refresh modify table
      }
    }
    
    //==== Load Data for Main Table (অ্যাকশন কলাম নেই) ====
    async function loadData(skipLoading = false) {
      if(!skipLoading) showLoading();
      let query = supabaseClient
        .from('data_entries')
        .select('*')
        .order('id', { ascending: false });
      const dateVal = filterDate.value;
      const monthVal = filterMonth.value;
      const yearVal = filterYear.value;
      const orderNoVal = filterOrderNo.value.trim();
      if (dateVal) { query = query.eq('date', dateVal); }
      else {
        if (yearVal) { query = query.ilike('date', `${yearVal}-%`); }
        if (monthVal) { query = query.ilike('date', `%-${monthVal}-%`); }
      }
      if (orderNoVal) { query = query.ilike('order_no', `%${orderNoVal}%`); }
      const { data, error } = await query;
      if(!skipLoading) hideLoading();
      if (error) { showToast("ডেটা লোডে সমস্যা: " + error.message, "error"); return; }
      const tbody = document.getElementById("dataTable").querySelector("tbody");
      tbody.innerHTML = "";
      data.forEach(entry => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.date || '-'}</td>
          <td>${entry.order_no || '-'}</td>
          <td>${entry.party_name || '-'}</td>
          <td>${entry.seed_no || '-'}</td>
          <td>${entry.color_name || '-'}</td>
          <td>${entry.remarks || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    //==== Modify Modal Handling ====
    const modifyBtn = document.getElementById("modifyBtn");
    const modifyModal = document.getElementById("modifyModal");
    const closeModifyModal = document.getElementById("closeModifyModal");
    const modifyOrderNo = document.getElementById("modifyOrderNo");
    const modifyTableBody = document.getElementById("modifyTable").querySelector("tbody");

    modifyBtn.addEventListener("click", () => {
      modifyModal.classList.add("show");
      modifyOrderNo.value = "";
      // Clear table before search input is provided
      modifyTableBody.innerHTML = "";
    });
    closeModifyModal.addEventListener("click", () => { modifyModal.classList.remove("show"); });
    window.addEventListener("click", (e) => { if(e.target === modifyModal) modifyModal.classList.remove("show"); });

    //==== Load Data for Modify Modal (Order Search) ====
    async function loadModifyData() {
      const orderNoSearch = modifyOrderNo.value.trim();
      // If search input is empty, clear table
      if (!orderNoSearch) {
        modifyTableBody.innerHTML = "";
        return;
      }
      let query = supabaseClient
        .from('data_entries')
        .select('*')
        .order('id', { ascending: false })
        .ilike('order_no', `%${orderNoSearch}%`);
      const { data, error } = await query;
      if(error) {
        showToast("মডিফাই ডেটা লোডে সমস্যা: " + error.message, "error");
        return;
      }
      modifyTableBody.innerHTML = "";
      data.forEach(entry => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.date || '-'}</td>
          <td>${entry.order_no || '-'}</td>
          <td>${entry.party_name || '-'}</td>
          <td>${entry.seed_no || '-'}</td>
          <td>${entry.color_name || '-'}</td>
          <td>${entry.remarks || '-'}</td>
          <td>
            <button onclick="editEntry(${entry.id})">Edit</button>
            <button style="background:#d9534f" onclick="deleteEntry(${entry.id})">Delete</button>
          </td>
        `;
        modifyTableBody.appendChild(tr);
      });
    }

    // Debounce Modify Search Input
    const debouncedLoadModifyData = debounce(() => { loadModifyData(); }, 300);
    modifyOrderNo.addEventListener("input", debouncedLoadModifyData);

    //==== Photo Modal Handling ====
    closePhotoModal.addEventListener("click", () => { photoModal.classList.remove("show"); });
    window.addEventListener("click", (e) => { if(e.target === photoModal) photoModal.classList.remove("show"); });
    function attachImagePreviewEvents() {
      const images = document.querySelectorAll(".preview-img");
      images.forEach(img => {
        img.addEventListener("click", (e) => {
          photoSpinner.style.display = "block";
          modalImg.src = e.target.src;
          modalImg.onload = function() { photoSpinner.style.display = "none"; };
          photoModal.classList.add("show");
        });
      });
    }
    
    //==== Filter Events for Main Table ====
    filterDate.addEventListener("change", () => { loadData(); });
    filterMonth.addEventListener("change", () => { loadData(); });
    filterYear.addEventListener("input", () => { loadData(); });
    filterOrderNo.addEventListener("input", debounce(() => { loadData(true); }, 300));

    //==== Load Data on Page Load ====
    window.addEventListener("load", () => { loadData(); });
  </script>
</body>
</html>
